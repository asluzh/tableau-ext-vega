import{l as e}from"./logger-BcLytKeK.js";import{r as s,j as E,l as c,e as S,c as O}from"./vendor-CAmHtlJc.js";const N="tableau-ext-vega",k="0.2.8",R={name:N,version:k};function B(){e.debug("Opening configure popup");const r=`${window.location.origin}/tableau-ext-vega/configure.html`;tableau.extensions.ui.displayDialogAsync(r,null,{height:600,width:600}).then(t=>{e.debug("displayDialogAsync was closed with payload:",t)}).catch(t=>{switch(t.errorCode){case tableau.ErrorCodes.DialogClosedByUser:e.debug("Dialog was closed by user");break;default:e.error(t.message)}})}function I(){const r=s.useRef(null),t=s.useRef(null),[p,b]=s.useState([]),[d,T]=s.useState(null),[l,j]=s.useState(null);return s.useEffect(()=>{let v=!1,m=!1,x=!1,i=null,a=null,o=null,w=!1;const C=async n=>{if(e.debug("updateData from",n.name),w){e.debug("updateData cancelled");return}try{const u=await n.getSummaryDataReaderAsync(void 0,{ignoreSelection:!0});if(e.debug("Data reader row count:",u.totalRowCount),u.pageCount>0)try{const g=await u.getAllPagesAsync(),D=g.columns.map(f=>f.fieldName);e.debug("Worksheet columns:",D);const y=g.data.map(f=>{const L={};return f.forEach((F,z)=>{L[D[z]]=F.value}),L});b(y)}catch(g){e.error("getAllPagesAsync failed:",g.toString()),b([])}finally{await u.releaseAsync()}else e.log("Empty data in worksheet:",n.name),b([])}catch(u){e.error("getSummaryDataReaderAsync failed:",u.toString()),b([])}finally{v&&!i&&(e.debug("Added FilterChanged event listener"),i=n.addEventListener(tableau.TableauEventType.FilterChanged,()=>{e.debug("FilterChanged event"),C(n)})),m&&!a&&(e.debug("Added SummaryDataChanged event listener"),a=n.addEventListener(tableau.TableauEventType.SummaryDataChanged,()=>{e.debug("SummaryDataChanged event"),C(n)})),x&&!o&&(e.debug("Added DashboardLayoutChanged event listener"),o=n.parentDashboard.addEventListener(tableau.TableauEventType.DashboardLayoutChanged,()=>{e.debug("DashboardLayoutChanged event")}))}},A=async()=>{const n=tableau.extensions.settings.get("sheet");e.debug("Data sheet",n);const u=tableau.extensions.settings.get("embedOptions").replace(/(\r|\n)/g," ");T(c.parse(u));const g=tableau.extensions.settings.get("jsonSpec").replace(/(\r|\n)/g," ");if(j(c.parse(g)),v=tableau.extensions.settings.get("listenerFilterEvent")==="true",m=tableau.extensions.settings.get("listenerDataChanged")==="true",x=tableau.extensions.settings.get("listenerDashboardLayout")==="true",r.current.style=tableau.extensions.settings.get("mainDivStyle"),i&&(i(),i=null,e.debug("Removed FilterChanged event listener")),a&&(a(),a=null,e.debug("Removed SummaryDataChanged event listener")),o&&(o(),o=null,e.debug("Removed DashboardLayoutChanged event listener")),n){const y=tableau.extensions.dashboardContent.dashboard.worksheets.find(f=>f.name==n);if(!y){e.warn("Worksheet not found:",n),b([]);return}C(y)}};e.debug("useEffect");let h=null;return tableau.extensions.initializeAsync({configure:B}).then(()=>{e.debug("initializeAsync completed"),A(),h=tableau.extensions.settings.addEventListener(tableau.TableauEventType.SettingsChanged,n=>{e.debug("Settings changed:",n),A()})},n=>{e.error("initializeAsync failed:",n.toString())}),e.log("Running",R.name,R.version),()=>{w=!0,e.debug("useEffect unmount"),h&&(h(),h=null,e.debug("Removed SettingsChanged event listener")),i&&(i(),i=null,e.debug("Removed FilterChanged event listener")),a&&(a(),a=null,e.debug("Removed SummaryDataChanged event listener")),o&&(a(),a=null,e.debug("Removed DashboardLayoutChanged event listener")),t.current?.finalize()}},[]),s.useEffect(()=>{e.debug("useEffect data update"),p&&(t.current?t.current.view.data("vizdata",p).runAsync():e.debug("No embed instance yet"))},[t,p]),s.useEffect(()=>{e.debug("useEffect embed settings update"),(async()=>{if(r.current&&d&&l)try{t.current?(c.stringify(t.current.spec)!==c.stringify(l)&&(e.debug("New spec received, re-embedding"),await t.current.finalize(),t.current=await S(r.current,l,d)),c.stringify(t.current.embedOptions)!==c.stringify(d)&&(e.debug("New options received, re-embedding"),await t.current.finalize(),t.current=await S(r.current,l,d))):t.current||(e.debug("Initial embedding"),t.current=await S(r.current,l,d))}catch(m){e.error("Error creating view:",m.toString())}})()},[t,d,l]),E.jsx("div",{ref:r})}O.createRoot(document.getElementById("root")).render(E.jsx(s.StrictMode,{children:E.jsx(I,{})}));
