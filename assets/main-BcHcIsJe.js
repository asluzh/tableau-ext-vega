import{l as e}from"./logger-BcLytKeK.js";import{r as s,j as E,l as c,e as D,c as O}from"./vendor-CAmHtlJc.js";const N="tableau-ext-vega",k="0.2.6",L={name:N,version:k};function B(){e.debug("Opening configure popup");const r=`${window.location.origin}/tableau-ext-vega/configure.html`;tableau.extensions.ui.displayDialogAsync(r,null,{height:600,width:600}).then(t=>{e.debug("displayDialogAsync was closed with payload:",t)}).catch(t=>{switch(t.errorCode){case tableau.ErrorCodes.DialogClosedByUser:e.debug("Dialog was closed by user");break;default:e.error(t.message)}})}function I(){const r=s.useRef(null),t=s.useRef(null),[y,b]=s.useState([]),[l,R]=s.useState(null),[o,T]=s.useState(null);return s.useEffect(()=>{let p=!1,f=!1,S=!1,i=null,n=null,g=null,w=!1;const v=async a=>{if(e.debug("updateData from",a.name),w){e.debug("updateData cancelled");return}try{const u=await a.getSummaryDataReaderAsync(void 0,{ignoreSelection:!0});if(e.debug("Data reader row count:",u.totalRowCount),u.pageCount>0)try{const d=await u.getAllPagesAsync(),h=d.columns.map(C=>C.fieldName);e.debug("Worksheet columns:",h);const j=d.data.map(C=>{const A={};return C.forEach((F,z)=>{A[h[z]]=F.value}),A});b(j)}catch(d){e.error("getAllPagesAsync failed:",d.toString()),b([])}finally{await u.releaseAsync()}else e.log("Empty data in worksheet:",a.name),b([])}catch(u){e.error("getSummaryDataReaderAsync failed:",u.toString()),b([])}finally{p&&!i&&(e.debug("Added FilterChanged event listener"),i=a.addEventListener(tableau.TableauEventType.FilterChanged,()=>{e.debug("FilterChanged event"),v(a)})),f&&!n&&(e.debug("Added SummaryDataChanged event listener"),n=a.addEventListener(tableau.TableauEventType.SummaryDataChanged,()=>{e.debug("SummaryDataChanged event"),v(a)})),S&&!g&&(e.debug("Added DashboardLayoutChanged event listener"),g=a.parentDashboard.addEventListener(tableau.TableauEventType.DashboardLayoutChanged,()=>{e.debug("DashboardLayoutChanged event")}))}},x=async()=>{let a=tableau.extensions.settings.get("sheet");if(e.debug("Data sheet",a),R(c.parse(tableau.extensions.settings.get("embedOptions"))),T(c.parse(tableau.extensions.settings.get("jsonSpec"))),p=tableau.extensions.settings.get("listenerFilterEvent")==="true",f=tableau.extensions.settings.get("listenerDataChanged")==="true",S=tableau.extensions.settings.get("listenerDashboardLayout")==="true",r.current.style=tableau.extensions.settings.get("mainDivStyle"),i&&(i(),i=null,e.debug("Removed FilterChanged event listener")),n&&(n(),n=null,e.debug("Removed SummaryDataChanged event listener")),g&&(g(),g=null,e.debug("Removed DashboardLayoutChanged event listener")),a){const d=tableau.extensions.dashboardContent.dashboard.worksheets.find(h=>h.name==a);if(!d){e.warn("Worksheet not found:",a),b([]);return}v(d)}};e.debug("useEffect");let m=null;return tableau.extensions.initializeAsync({configure:B}).then(()=>{e.debug("initializeAsync completed"),x(),m=tableau.extensions.settings.addEventListener(tableau.TableauEventType.SettingsChanged,a=>{e.debug("Settings changed:",a),x()})},a=>{e.error("initializeAsync failed:",a.toString())}),e.log("Running",L.name,L.version),()=>{w=!0,e.debug("useEffect unmount"),m&&(m(),m=null,e.debug("Removed SettingsChanged event listener")),i&&(i(),i=null,e.debug("Removed FilterChanged event listener")),n&&(n(),n=null,e.debug("Removed SummaryDataChanged event listener")),g&&(n(),n=null,e.debug("Removed DashboardLayoutChanged event listener")),t.current?.finalize()}},[]),s.useEffect(()=>{e.debug("useEffect data update"),y&&(t.current?t.current.view.data("vizdata",y).runAsync():e.debug("No embed instance yet"))},[t,y]),s.useEffect(()=>{e.debug("useEffect embed settings update"),(async()=>{if(r.current&&l&&o)try{t.current?(c.stringify(t.current.spec)!==c.stringify(o)&&(e.debug("New spec received, re-embedding"),await t.current.finalize(),t.current=await D(r.current,o,l)),c.stringify(t.current.embedOptions)!==c.stringify(l)&&(e.debug("New options received, re-embedding"),await t.current.finalize(),t.current=await D(r.current,o,l))):t.current||(e.debug("Initial embedding"),t.current=await D(r.current,o,l))}catch(f){e.error("Error creating view:",f.toString())}})()},[t,l,o]),E.jsx("div",{ref:r})}O.createRoot(document.getElementById("root")).render(E.jsx(s.StrictMode,{children:E.jsx(I,{})}));
