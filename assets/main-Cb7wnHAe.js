import{l as e}from"./logger-CymvLjlT.js";import{r as s,j as S,l as d,e as v,c as j}from"./vendor-CAmHtlJc.js";const z="tableau-ext-vega",O="0.2.9",C={name:z,version:O};function k(){e.debug("Opening configure popup");const r=`${window.location.origin}/tableau-ext-vega/configure.html`;tableau.extensions.ui.displayDialogAsync(r,null,{height:600,width:600}).then(t=>{e.debug("displayDialogAsync was closed with payload:",t)}).catch(t=>{switch(t.errorCode){case tableau.ErrorCodes.DialogClosedByUser:e.debug("Dialog was closed by user");break;default:e.error(t.message)}})}function L(){const r=s.useRef(null),t=s.useRef(null),[p,c]=s.useState([]),[u,D]=s.useState(null),[o,A]=s.useState(null);return s.useEffect(()=>{let g="",a=null,f=null,w=!1;const y=async n=>{if(e.debug("updateData from",n.name),w){e.debug("updateData cancelled");return}try{const i=await n.getSummaryDataReaderAsync(void 0,{ignoreSelection:!0});if(e.debug("Data reader row count:",i.totalRowCount),i.pageCount>0)try{const l=await i.getAllPagesAsync(),h=l.columns.map(b=>b.fieldName);e.debug("Worksheet columns:",h);const m=l.data.map(b=>{const x={};return b.forEach((R,T)=>{x[h[T]]=R.value}),x});c(m)}catch(l){e.error("getAllPagesAsync failed:",l.toString()),c([])}finally{await i.releaseAsync()}else e.log("Empty data in worksheet:",n.name),c([])}catch(i){e.error("getSummaryDataReaderAsync failed:",i.toString()),c([])}finally{if(!a)switch(g){case"SummaryDataChanged":e.debug("Adding SummaryDataChanged event listener"),a=n.addEventListener(tableau.TableauEventType.SummaryDataChanged,()=>{e.debug("SummaryDataChanged event"),y(n)});break;case"FilterChanged":e.debug("Adding FilterChanged event listener"),a=n.addEventListener(tableau.TableauEventType.FilterChanged,()=>{e.debug("FilterChanged event"),y(n)});break}}},E=async()=>{a&&(e.debug(`Removing ${g} event listener`),a(),a=null);const n=tableau.extensions.settings.get("sheet");e.debug("Data sheet",n);const i=tableau.extensions.settings.get("jsonSpec").replace(/(\r|\n)/g,"");A(d.parse(i));const l=tableau.extensions.settings.get("embedOptions").replace(/(\r|\n)/g,"");if(D(d.parse(l)),g=tableau.extensions.settings.get("listenerDataChanged"),r.current.style=tableau.extensions.settings.get("mainDivStyle"),n){const m=tableau.extensions.dashboardContent.dashboard.worksheets.find(b=>b.name==n);if(!m){e.warn("Worksheet not found:",n),c([]);return}y(m)}};return e.debug("useEffect"),tableau.extensions.initializeAsync({configure:k}).then(()=>{e.debug("initializeAsync completed, Tableau environment:",tableau.extensions.environment.tableauVersion),E(),f=tableau.extensions.settings.addEventListener(tableau.TableauEventType.SettingsChanged,n=>{e.debug("Settings changed:",n),E()})},n=>{e.error("initializeAsync failed:",n.toString())}),e.log("Running",C.name,C.version),()=>{w=!0,e.debug("useEffect unmount"),f&&(f(),f=null,e.debug("Removed SettingsChanged event listener")),a&&(e.debug(`Removing ${g} event listener`),a(),a=null),t.current?.finalize()}},[]),s.useEffect(()=>{e.debug("useEffect data update"),p&&(t.current?t.current.view.data("vizdata",p).runAsync():e.debug("No embed instance yet"))},[t,p]),s.useEffect(()=>{e.debug("useEffect embed settings update"),(async()=>{if(r.current&&u&&o)try{t.current?(d.stringify(t.current.spec)!==d.stringify(o)&&(e.debug("New spec received, re-embedding"),await t.current.finalize(),t.current=await v(r.current,o,u)),d.stringify(t.current.embedOptions)!==d.stringify(u)&&(e.debug("New options received, re-embedding"),await t.current.finalize(),t.current=await v(r.current,o,u))):t.current||(e.debug("Initial embedding"),t.current=await v(r.current,o,u))}catch(a){e.error("Error creating view:",a.toString())}})()},[t,u,o]),S.jsx("div",{ref:r})}j.createRoot(document.getElementById("root")).render(S.jsx(s.StrictMode,{children:S.jsx(L,{})}));
